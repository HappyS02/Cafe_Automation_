@model IEnumerable<IGrouping<string, CafeOtomasyon.Models.TableModel>>

@{
    ViewData["Title"] = "Kat Planı";
}

<div class="row mb-3">
    <div class="col-auto">
        <span class="badge bg-success p-2">BOŞ</span>
    </div>
    <div class="col-auto">
        <span class="badge bg-danger p-2">DOLU</span>
    </div>
    <div class="col-auto">
        <span class="badge bg-warning text-dark p-2">REZERVE</span>
    </div>
</div>

<div class="container-fluid px-0">

    @foreach (var locationGroup in Model)
    {
        <h2 class="mt-4 border-bottom">@locationGroup.Key</h2>

        <div class="d-flex flex-wrap gap-3">

            @foreach (var table in locationGroup)
            {
                // Masanın durumuna göre renk sınıfını belirleyelim
                string cardColorClass = "bg-light";
                string textColorClass = "text-dark";
                
                @switch (table.Status)
                {
                    case TableStatus.Boş:
                        cardColorClass = "bg-success";
                        textColorClass = "text-white";
                        break;
                    case TableStatus.Dolu:
                        cardColorClass = "bg-danger";
                        textColorClass = "text-white";
                        break;
                    case TableStatus.Rezerve:
                        cardColorClass = "bg-warning";
                        textColorClass = "text-dark";
                        break;
                }

                <a href="#"
                   class="text-decoration-none table-card"
                   data-bs-toggle="modal"
                   data-bs-target="#tableModal"
                   data-table-id="@table.Id"
                   data-table-name="@table.Name">

                    <div class="card shadow-sm @cardColorClass @textColorClass" style="width: 12rem; height: 10rem;">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <h3 class="card-title">@table.Name</h3>
                            <p class="card-text"><i class="fas fa-users"></i> @table.Capacity Kişilik</p>
                        </div>
                    </div>
                </a>
                
            }
        </div>
    }
</div>

<div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tableModalLabel">Masa Detayları</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h3 id="modalTableName">Yükleniyor...</h3>
                <hr>

                <div class="mb-3">
                    <strong>Durumu Değiştir:</strong>
                    <button id="btnMakeAvailable" class="btn btn-success" style="display: none;">BOŞ YAP</button>
                    <button id="btnMakeOccupied" class="btn btn-danger" style="display: none;">DOLU YAP</button>
                    <button id="btnMakeReserved" class="btn btn-warning" style="display: none;">REZERVE YAP</button>
                </div>
                <hr>


                @if(User.IsInRole(AppRoles.Yönetici) || User.IsInRole(AppRoles.Kasiyer)){
                <div id="printButtonSection" style="display: none;" class="mb-3 text-end">
                    <button id="btnPrintReceipt" class="btn btn-info">
                        <i class="fas fa-print"></i> Adisyon Yazdır
                    </button>
                </div>
                }


                <div id="orderSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h4>Sipariş</h4>
                        <button id="btnShowProductModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productSelectModal">
                            <i class="fas fa-plus"></i> Siparişe Ürün Ekle
                        </button>
                    </div>

                    <div id="orderDetails">
                        <p>Bu masaya ait aktif bir sipariş bulunmuyor.</p>
                    </div>
                </div>
                <h4 class="text-end mt-3">Toplam Tutar: <span id="totalAmount">0,00 TL</span></h4>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                @* Ödeme Butonu (Doğru ID ve Rol Kontrolü) *@
                @if (User.IsInRole(AppRoles.Yönetici) || User.IsInRole(AppRoles.Kasiyer))
                {
                    <button type="button" class="btn btn-success" id="btnPayment" style="display: none;">ÖDEME AL</button>
                }
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="productSelectModal" tabindex="-1" aria-labelledby="productSelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productSelectModalLabel">Ürün Seçin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="productCardContainer" class="d-flex flex-wrap gap-3">
                    <p>Aktif ürünler yükleniyor...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Modal instance'larını al
            var tableModalEl = document.getElementById('tableModal');
            var tableModalInstance = new bootstrap.Modal(tableModalEl);
            var productModalEl = document.getElementById('productSelectModal');
            var productModalInstance = new bootstrap.Modal(productModalEl);

            var printButtonSection = document.getElementById('printButtonSection'); 
            var btnPrintReceipt = document.getElementById('btnPrintReceipt');

            // Gerekli DOM elemanlarını seç (Hata olmaması için başta null kontrolü yapalım)
            var btnMakeAvailable = document.getElementById('btnMakeAvailable');
            var btnMakeOccupied = document.getElementById('btnMakeOccupied');
            var btnMakeReserved = document.getElementById('btnMakeReserved');
            var btnPayment = document.getElementById('btnPayment');
            var orderSection = document.getElementById('orderSection');
            var orderDetailsContainer = document.getElementById('orderDetails');
            var totalAmountSpan = tableModalEl.querySelector('#totalAmount'); // Bu modal içinde olduğu kesin
            var productCardContainer = document.getElementById('productCardContainer');
            var btnShowProductModal = document.getElementById('btnShowProductModal');

             // Hata Ayıklama: Elemanlar bulundu mu?
             console.log({btnMakeAvailable, btnMakeOccupied, btnMakeReserved, btnPayment, orderSection, orderDetailsContainer, productCardContainer, btnShowProductModal});


            // Global değişkenler
            var currentTableId = 0;
            var currentOrderId = 0;
            var currentTableName = '';
            var currentTableCard = null;

            // ---- ANA MASA MODALI ----
            tableModalEl.addEventListener('show.bs.modal', function (event) {
                console.log("Ana Modal Açılıyor...");
                var link = event.relatedTarget;
                if (!link || !link.classList.contains('table-card')) {
                    console.error("Modal tetikleyici link bulunamadı veya 'table-card' değil."); return;
                }
                currentTableCard = link;
                currentTableName = link.getAttribute('data-table-name');
                currentTableId = link.getAttribute('data-table-id');
                tableModalEl.querySelector('.modal-title').textContent = currentTableName + ' - Sipariş Detayları';
                tableModalEl.querySelector('#modalTableName').textContent = currentTableName;
                resetModalContent();
                refreshOrderDetails(currentTableId);
            });

            function resetModalContent(){
                console.log("resetModalContent çağrıldı.");
                if(orderDetailsContainer) orderDetailsContainer.innerHTML = '<p>Sipariş detayları yükleniyor...</p>';
                if(totalAmountSpan) totalAmountSpan.textContent = '...';
                // ID'leri kontrol etmeden style değiştirmeyi dene (hata vermemeli)
                if(orderSection) orderSection.style.display = 'none';
                if(btnPayment) btnPayment.style.display = 'none';
                if(btnMakeAvailable) btnMakeAvailable.style.display = 'none';
                if(btnMakeOccupied) btnMakeOccupied.style.display = 'none';
                if(btnMakeReserved) btnMakeReserved.style.display = 'none';
            }

            function refreshOrderDetails(tableId) {
                console.log(`refreshOrderDetails çağrıldı: tableId = ${tableId}`);
                fetch(`/Tables/GetTableDetails/${tableId}`)
                    .then(response => response.ok ? response.json() : Promise.reject(`HTTP error! status: ${response.status}`))
                    .then(data => {
                        console.log("GetTableDetails Cevabı:", data);
                        currentOrderId = data.orderId;
                        renderOrderDetails(data.details);
                        if(totalAmountSpan) totalAmountSpan.textContent = data.totalAmount.toFixed(2) + ' TL';
                        updateButtonVisibility(data.status); // Butonları gelen duruma göre ayarla


                        if (printButtonSection) {
                            printButtonSection.style.display = (data.status === 'Dolu') ? 'block' : 'none';
                        }
                    })
                    .catch(error => {
                        console.error("refreshOrderDetails Hatası:", error);
                        if(orderDetailsContainer) orderDetailsContainer.innerHTML = '<p class="text-danger">Sipariş detayları yüklenemedi.</p>';
                    });
            }


            if (btnPrintReceipt) {
                 btnPrintReceipt.addEventListener('click', function() {
                    if (currentOrderId && currentOrderId > 0) {
                        // Yeni sekmede PrintReceipt sayfasını aç
                        window.open(`/Orders/PrintReceipt/${currentOrderId}`, '_blank');
                    } else {
                        alert("Yazdırılacak aktif bir sipariş bulunamadı.");
                    }
                 });
            } else { console.error("btnPrintReceipt butonu bulunamadı!"); }




            // ---- ÜRÜN SEÇME MODALI ----
             if (btnShowProductModal) { // Buton varsa olay dinleyici ekle
                 btnShowProductModal.addEventListener('click', function () {
                    console.log("Ürün Seçme Modalı açılıyor...");
                    if(!productCardContainer) { console.error("productCardContainer bulunamadı!"); return; }
                    productCardContainer.innerHTML = '<p>Aktif ürünler yükleniyor...</p>';
                    fetch('/Orders/GetActiveProducts')
                        .then(response => response.json())
                        .then(products => {
                            productCardContainer.innerHTML = '';
                            if (!products || products.length === 0) { productCardContainer.innerHTML = '<p>Aktif ürün bulunamadı.</p>'; return; }
                            products.forEach(product => {
                                var cardHtml = `<div class="card product-card" style="width: 10rem; cursor: pointer;" data-product-id="${product.id}">...</div>`;
                                // HTML içeriğini bir önceki cevaptan alın
                                 cardHtml = `
                                    <div class="card product-card" style="width: 10rem; cursor: pointer;" data-product-id="${product.id}">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">${product.name}</h6>
                                            <p class="card-text text-muted">${product.price.toFixed(2)} TL</p>
                                        </div>
                                    </div>`;
                                productCardContainer.insertAdjacentHTML('beforeend', cardHtml);
                            });
                            console.log("Ürün kartları HTML'e eklendi.");
                        })
                        .catch(error => console.error("GetActiveProducts Hatası:", error));
                 });
             } else { console.error("btnShowProductModal bulunamadı!"); }

            if (productCardContainer) { // Container varsa olay dinleyici ekle
                productCardContainer.addEventListener('click', function (event) {
                    var card = event.target.closest('.product-card');
                    if (!card) return;
                    var productId = card.getAttribute('data-product-id');
                    console.log(`Ürün kartına tıklandı. productId = ${productId}, currentOrderId = ${currentOrderId}`);
                    if (!productId || productId === 'undefined' || productId === null) { console.error("HATA: Product ID alınamadı!"); alert("Ürün ID'si alınamadı!"); return; }
                    if (!currentOrderId || currentOrderId <= 0) { console.error("HATA: Geçerli Order ID yok!"); alert("Masaya ürün eklemek için önce sipariş başlatılmalı."); productModalInstance.hide(); return; }

                    fetch(`/Orders/AddItemToOrder?orderId=${currentOrderId}&productId=${productId}&quantity=1`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                        .then(response => response.json())
                        .then(data => {
                            console.log("AddItemToOrder cevabı:", data);
                            if (data.success) { productModalInstance.hide(); refreshOrderDetails(currentTableId); }
                            else { alert("Hata: " + data.message); }
                        })
                        .catch(error => console.error("AddItemToOrder Hatası:", error));
                });
            } else { console.error("productCardContainer bulunamadı!"); }

            // ---- DURUM BUTONLARI ----
            if(btnMakeOccupied) btnMakeOccupied.addEventListener('click', function() { postStatusChange(`/Tables/StartOrder/${currentTableId}`); }); else console.error("btnMakeOccupied bulunamadı!");
            if(btnMakeAvailable) btnMakeAvailable.addEventListener('click', function() { postStatusChange(`/Tables/CloseOrder/${currentTableId}`); }); else console.error("btnMakeAvailable bulunamadı!");
            if(btnMakeReserved) btnMakeReserved.addEventListener('click', function() { postStatusChange(`/Tables/ReserveTable/${currentTableId}`); }); else console.error("btnMakeReserved bulunamadı!");
            if(btnPayment) btnPayment.addEventListener('click', function() { /* Ödeme kodu buraya gelecek */ console.log("Ödeme Butonu Tıklandı");
                 if (!currentOrderId || currentOrderId <= 0) { console.error("HATA: Ödeme alınacak geçerli bir sipariş ID'si yok!"); alert("Ödeme alınacak aktif bir sipariş bulunamadı."); return; }
                 var totalAmountText = totalAmountSpan ? totalAmountSpan.textContent : 'Bilinmeyen Tutar';
                 if (!confirm(`${currentTableName} için ${totalAmountText} tutarındaki ödeme alındı mı? Sipariş kapatılacak ve masa boşa alınacak.`)) { return; }
                 fetch(`/Orders/MarkOrderAsPaid?orderId=${currentOrderId}`, { method: 'POST', headers: { 'Content-Type': 'application/json' } })
                    .then(response => response.json())
                    .then(data => {
                        console.log("MarkOrderAsPaid cevabı:", data);
                        if (data.success) { tableModalInstance.hide(); updateCardColor(data.newStatus); currentOrderId = 0; }
                        else { alert("Hata: " + data.message); }
                    })
                    .catch(error => { console.error("MarkOrderAsPaid Hatası:", error); alert("Ödeme işlemi sırasında bir ağ hatası oluştu."); });

             }); else console.log("Ödeme butonu (btnPayment) bulunamadı veya kullanıcı yetkili değil."); // Yönetici/Kasiyer değilse bu normal

            // ---- SİPARİŞ DETAY BUTONLARI ----
            if(orderDetailsContainer) {
                 orderDetailsContainer.addEventListener('click', function(event) {
                     var button = event.target.closest('button[data-action]');
                     if (!button) return;
                     var detailId = button.getAttribute('data-detail-id');
                     var action = button.getAttribute('data-action');
                     var url = '';
                     console.log(`Sipariş detayı butonu tıklandı: action=${action}, detailId=${detailId}`);
                     if (action === 'increase') url = `/Orders/UpdateItemQuantity?orderDetailId=${detailId}&quantityChange=1`;
                     else if (action === 'decrease') url = `/Orders/UpdateItemQuantity?orderDetailId=${detailId}&quantityChange=-1`;
                     else if (action === 'delete') { if (!confirm('Ürünü silmek istediğinize emin misiniz?')) return; url = `/Orders/RemoveItemFromOrder?orderDetailId=${detailId}`; }
                     else return;
                     fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }})
                         .then(response => response.json())
                         .then(data => { console.log(`Sipariş Detayı Güncelleme (${action}) cevabı:`, data); if (data.success) refreshOrderDetails(currentTableId); else alert("Hata: " + data.message); })
                         .catch(error => console.error(`Sipariş Detayı Güncelleme (${action}) Hatası:`, error));
                 });
            } else { console.error("orderDetailsContainer bulunamadı!"); }


            // ---- YARDIMCI FONKSİYONLAR ----
            function renderOrderDetails(details) { /* ... Önceki cevaptaki kod ... */
                 if(!orderDetailsContainer) return; // Güvenlik kontrolü
                 if (!details || details.length === 0) { orderDetailsContainer.innerHTML = '<p>Aktif sipariş bulunmuyor.</p>'; return; }
                 var html = '<table class="table table-sm table-striped"><thead><tr><th>Ürün</th><th>Fiyat</th><th style="width: 130px;">Adet</th><th>Toplam</th><th style="width: 50px;"></th></tr></thead><tbody>';
                 details.forEach(item => {
                     let detailId = item.orderDetailId; // Controller bu ID'yi gönderiyor
                     html += `<tr><td>${item.productName}</td><td>${item.price.toFixed(2)} TL</td><td><div class="input-group input-group-sm"><button class="btn btn-outline-secondary" type="button" data-action="decrease" data-detail-id="${detailId}">-</button><input type="text" class="form-control text-center" value="${item.quantity}" readonly><button class="btn btn-outline-secondary" type="button" data-action="increase" data-detail-id="${detailId}">+</button></div></td><td><strong>${(item.quantity * item.price).toFixed(2)} TL</strong></td><td><button class="btn btn-danger btn-sm" type="button" data-action="delete" data-detail-id="${detailId}"><i class="fas fa-trash-alt"></i></button></td></tr>`;
                 });
                 html += '</tbody></table>';
                 orderDetailsContainer.innerHTML = html;
             }

            function updateButtonVisibility(status) {
                 console.log(`updateButtonVisibility çağrıldı: status = ${status}`);
                 // ID'leri kontrol et
                 if(btnMakeAvailable) btnMakeAvailable.style.display = (status === 'Dolu' || status === 'Rezerve') ? 'inline-block' : 'none';
                 if(btnMakeOccupied) btnMakeOccupied.style.display = (status === 'Boş') ? 'inline-block' : 'none';
                 if(btnMakeReserved) btnMakeReserved.style.display = (status === 'Boş') ? 'inline-block' : 'none';
                 if(btnPayment) btnPayment.style.display = (status === 'Dolu') ? 'inline-block' : 'none';
                 if(orderSection) orderSection.style.display = (status === 'Dolu') ? 'block' : 'none';
            }

            function updateCardColor(newStatusString){ /* ... Önceki cevaptaki kod ... */
                if (!currentTableCard) return;
                var cardDiv = currentTableCard.querySelector('.card');
                cardDiv.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white', 'text-dark', 'bg-light');
                if (newStatusString === 'Dolu') cardDiv.classList.add('bg-danger', 'text-white');
                else if (newStatusString === 'Rezerve') cardDiv.classList.add('bg-warning', 'text-dark');
                else cardDiv.classList.add('bg-success', 'text-white');
             }

            function postStatusChange(url) { /* ... Önceki cevaptaki kod ... */
                 console.log(`postStatusChange çağrıldı: url = ${url}`);
                 fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }})
                 .then(response => response.json())
                 .then(data => {
                     console.log("postStatusChange cevabı:", data);
                     if (data.success) {
                         if (data.orderId) { currentOrderId = data.orderId; console.log(`Yeni Order ID set edildi: ${currentOrderId}`); }
                         else if (data.newStatus === 'Boş' || data.newStatus === 'Rezerve') { currentOrderId = 0; console.log("Order ID sıfırlandı."); }
                         refreshOrderDetails(currentTableId); // Önce modalı yenile
                         updateCardColor(data.newStatus); // Sonra kartı boya
                         // modalInstance.hide(); // Durum değişince modalı kapatmak istemeyebiliriz, kullanıcı siparişe devam edebilir.
                     } else { alert("Hata: " + data.message); }
                 })
                 .catch(error => console.error('postStatusChange Hatası:', error));
             }

        }); // DOMContentLoaded sonu
    </script>
}